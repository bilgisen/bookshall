name: Publish Content

on:
  workflow_dispatch:
    inputs:
      book_id:
        description: 'ID of the book to publish'
        required: true
        type: string
      user_id:
        description: 'ID of the user triggering the publish'
        required: true
        type: string
      session_id:
        description: 'Session ID for tracking the publish process'
        required: true
        type: string
      content_id:
        description: 'ID of the content (book) to publish'
        required: true
        type: string
      toc_level:
        description: 'Table of contents depth'
        required: false
        type: number
        default: 3
      include_metadata:
        description: 'Include metadata in EPUB'
        required: false
        type: boolean
        default: true
      include_cover:
        description: 'Include cover image in EPUB'
        required: false
        type: boolean
        default: true
      include_toc:
        description: 'Include table of contents'
        required: false
        type: boolean
        default: true
      include_imprint:
        description: 'Include imprint page'
        required: false
        type: boolean
        default: true
      metadata:
        description: 'Additional metadata JSON string'
        required: false
        type: string
        default: '{}'

jobs:
  build-epub:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc awscli jq curl

      - name: Validate & export inputs
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          NEXT_PUBLIC_APP_URL: https://bookshall.com
          BOOK_ID: ${{ inputs.book_id }}
          USER_ID: ${{ inputs.user_id }}
          SESSION_ID: ${{ inputs.session_id }}
          CONTENT_ID: ${{ inputs.content_id }}
          TOC_LEVEL: ${{ inputs.toc_level }}
          INCLUDE_METADATA: ${{ inputs.include_metadata }}
          INCLUDE_COVER: ${{ inputs.include_cover }}
          INCLUDE_TOC: ${{ inputs.include_toc }}
          INCLUDE_IMPRINT: ${{ inputs.include_imprint }}
          METADATA: ${{ toJson(inputs.metadata) }}
        run: |
          bash ./scripts/validate-inputs.sh

      - name: Fetch book + Build EPUB
        run: |
          bash ./scripts/fetch-book.sh

      - name: Upload EPUB to Cloudflare R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          EPUB_FILE=$(ls *.epub | head -n1)
          echo "Uploading $EPUB_FILE to R2..."
          aws s3 cp "$EPUB_FILE" "s3://${R2_BUCKET}/$EPUB_FILE" \
            --endpoint-url "${R2_ENDPOINT}" \
            --acl public-read
