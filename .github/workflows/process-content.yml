name: Publish Content

on:
  workflow_dispatch:
    inputs:
      book_id:
        description: 'Book ID'
        required: true
        type: string
      user_id:
        description: 'User ID'
        required: true
        type: string
      session_id:
        description: 'Session ID'
        required: true
        type: string
      content_id:
        description: 'Content ID'
        required: true
        type: string
      include_metadata:
        description: 'Include metadata in EPUB'
        required: false
        type: boolean
        default: true
      include_cover:
        description: 'Include cover image'
        required: false
        type: boolean
        default: true
      include_toc:
        description: 'Include table of contents'
        required: false
        type: boolean
        default: true
      toc_level:
        description: 'Depth of table of contents (1-6)'
        required: false
        type: number
        default: 3
      include_imprint:
        description: 'Include imprint page'
        required: false
        type: boolean
        default: true
      metadata:
        description: 'Additional metadata (JSON string)'
        required: false
        type: string
        default: '{}'

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      BOOK_ID: ${{ github.event.inputs.book_id }}
      USER_ID: ${{ github.event.inputs.user_id }}
      SESSION_ID: ${{ github.event.inputs.session_id }}
      CONTENT_ID: ${{ github.event.inputs.content_id }}
      INCLUDE_METADATA: ${{ github.event.inputs.include_metadata }}
      INCLUDE_COVER: ${{ github.event.inputs.include_cover }}
      INCLUDE_TOC: ${{ github.event.inputs.include_toc }}
      TOC_LEVEL: ${{ github.event.inputs.toc_level }}
      INCLUDE_IMPRINT: ${{ github.event.inputs.include_imprint }}
      METADATA_JSON: ${{ github.event.inputs.metadata }}
      BASE_URL: https://bookshall.com
      API_URL: https://bookshall.com/api
      BOOKSHALL_API_KEY: ${{ secrets.BOOKSHALL_API_KEY }}

    steps:
      - name: Initial Debug - Print Environment
        run: |
          echo "üîÑ Starting workflow execution"
          echo "üìã Workflow Inputs:"
          echo "  - Book ID: ${{ github.event.inputs.book_id }}"
          echo "  - User ID: ${{ github.event.inputs.user_id }}"
          echo "  - Session ID: ${{ github.event.inputs.session_id }}"
          echo "  - Content ID: ${{ github.event.inputs.content_id }}"
          echo "  - Include Metadata: ${{ github.event.inputs.include_metadata }}"
          echo "  - Include Cover: ${{ github.event.inputs.include_cover }}"
          echo "  - Include TOC: ${{ github.event.inputs.include_toc }}"
          echo "  - TOC Level: ${{ github.event.inputs.toc_level }}"
          echo "  - Include Imprint: ${{ github.event.inputs.include_imprint }}"
          echo "  - Metadata: ${{ github.event.inputs.metadata }}"
          echo ""
          echo "üîë Checking environment variables:"
          echo "  - BASE_URL: $BASE_URL"
          echo "  - API_URL: $API_URL"
          echo "  - BOOKSHALL_API_KEY: ${BOOKSHALL_API_KEY:0:4}...${BOOKSHALL_API_KEY: -4} (${#BOOKSHALL_API_KEY} chars)"
          echo "  - CONTENT_ID: $CONTENT_ID"
          echo "  - INCLUDE_METADATA: $INCLUDE_METADATA"
          echo "  - INCLUDE_COVER: $INCLUDE_COVER"
          echo "  - INCLUDE_TOC: $INCLUDE_TOC"
          echo "  - TOC_LEVEL: $TOC_LEVEL"
          echo "  - INCLUDE_IMPRINT: $INCLUDE_IMPRINT"
          echo "  - METADATA_JSON: $METADATA_JSON"
          echo ""
          echo "üìÇ Current directory:"
          pwd
          ls -la

      # ... rest of your workflow steps ...

      - name: Debug - Print all inputs as JSON
        run: |
          echo "üìù All workflow inputs as JSON:"
          echo '{
            "book_id": "'${{ github.event.inputs.book_id }}'",
            "user_id": "'${{ github.event.inputs.user_id }}'",
            "session_id": "'${{ github.event.inputs.session_id }}'",
            "content_id": "'${{ github.event.inputs.content_id }}'",
            "include_metadata": "'${{ github.event.inputs.include_metadata }}'",
            "include_cover": "'${{ github.event.inputs.include_cover }}'",
            "include_toc": "'${{ github.event.inputs.include_toc }}'",
            "toc_level": "'${{ github.event.inputs.toc_level }}'",
            "include_imprint": "'${{ github.event.inputs.include_imprint }}'",
            "metadata": ${{ github.event.inputs.metadata }}
          }' | jq .