name: Publish Epub

on:
  workflow_dispatch:
    inputs:
      book_id:
        description: 'Book ID'
        required: true
        type: string
      user_id:
        description: 'User ID'
        required: true
        type: string
      session_id:
        description: 'Session ID'
        required: true
        type: string
      content_id:
        description: 'Content ID'
        required: true
        type: string

permissions:
  contents: read
  actions: read

jobs:
  build-epub:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL || 'https://bookshall.com' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y pandoc jq curl
          npm install -g pnpm
          pnpm install --no-frozen-lockfile

      - name: Set environment variables
        run: |
          export BOOK_ID="${{ inputs.book_id }}"
          export USER_ID="${{ inputs.user_id }}"
          export SESSION_ID="${{ inputs.session_id }}"
          export CONTENT_ID="${{ inputs.content_id }}"
          export COMBINED_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          mkdir -p ./work ./work/output ./work/payload ./work/chapters

      - name: Fetch book & generate EPUB
        run: |
          chmod +x ./scripts/fetch-book.sh
          ./scripts/fetch-book.sh

      - name: Upload EPUB to R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          FILE="./work/output/${CONTENT_ID}.epub"
          KEY="books/${CONTENT_ID}-$(date +%s).epub"
          curl -sSf -X PUT "${R2_ENDPOINT}/${R2_BUCKET}/$KEY" \
            -H "Authorization: Bearer ${R2_ACCESS_KEY_ID}:${R2_SECRET_ACCESS_KEY}" \
            -H "Content-Type: application/epub+zip" \
            --upload-file "$FILE"
          echo "EPUB_URL=${R2_PUBLIC_URL}/${R2_BUCKET}/$KEY" >> $GITHUB_OUTPUT
